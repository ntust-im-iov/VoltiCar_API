version: '3'

services:
  api:
    build: .
    container_name: volticar-api
    # 移除 ports 映射，流量將通過 Nginx
    environment:
      - DATABASE_URL=mongodb://Volticar:REMOVED_PASSWORD@59.126.6.46:27017/?authSource=admin
      - VOLTICAR_DB=Volticar
      - CHARGE_STATION_DB=charge_station
      - SECRET_KEY=REMOVED_SECRET_KEY
      - API_ENV=development
      - API_HOST=0.0.0.0
      - API_PORT=8000 # 更新為內部埠
      - PYTHONIOENCODING=utf-8
      - LANG=C.UTF-8
      - LC_ALL=C.UTF-8
      - REDIS_HOST=redis # 新增 Redis 主機環境變數
      - REDIS_PORT=6379
      - CAN_DATA_DIR=/app/can_data # CAN 數據檔案路徑
      # 移除 SSL 環境變數，Nginx 將處理 SSL
    volumes:
      - ./app:/app/app
      - ./requirements.txt:/app/requirements.txt
      - ./logs:/app/logs # 保留日誌映射
      - ./data:/app/data # 將 data 目錄映射到主機，用於存放 user_github_mappings.json 等數據檔案
      - ./can_data:/app/can_data:ro # CAN 數據檔案 (唯讀)
      - C:\Certbot:/etc/certs # 保留憑證映射，以防應用程式內部需要讀取
    extra_hosts: # 保留 extra_hosts
      - "volticar.dynns.com:192.168.1.102"
    # --- 新增埠映射，僅供主機 Nginx 訪問 ---
    ports:
      - "127.0.0.1:8000:8000" # 將容器 8000 埠映射到主機 localhost 的 8000 埠
    restart: always
    networks:
      - volticar-network
    command: > # 保持 --proxy-headers，並信任來自 localhost 和 Docker 內部連接 IP 的代理標頭
      uvicorn main:app --host 0.0.0.0 --port 8000 --proxy-headers --forwarded-allow-ips='127.0.0.1,172.18.0.1'
    depends_on:
      - redis

# --- 移除 Nginx 服務 ---
# nginx:
#   ... (整個 nginx 服務區塊被移除)

  redis:
    image: redis:7-alpine # 使用較新的 Alpine 版本以減小映像大小
    container_name: volticar-redis
    ports:
      - "127.0.0.1:6379:6379" # 將 Redis 埠映射到主機的 localhost，僅供本地開發/調試
    restart: always
    networks:
      - volticar-network
    # 可以選擇性地掛載一個 volume 來持久化 Redis 數據，但對於快取可能不需要
    # volumes:
    #   - redis-data:/data
    healthcheck: # 新增健康檢查
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  volticar-network:
    driver: bridge
# 如果選擇了持久化 Redis 數據，則需要定義 volume
# volumes:
#   redis-data:
